<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - SkillSwap</title>

    <!-- Main Styles -->
    <link rel="stylesheet" href="css/unified.css">

    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <!-- Config + Utilities + Auth -->
    <script src="js/api-config.js" defer></script>
    <script src="js/utils.js" defer></script>
    <script src="js/auth.js" defer></script>

    <!-- Navbar Loader -->
    <script src="js/common-navbar.js" defer></script>
</head>

<body>

    <!-- MAIN CONTENT -->
    <div class="main">
        <h2 id="dashboardTitle">Dashboard</h2>

        <!-- STAT CARDS -->
        <div class="stats-grid">

            <div class="stat-card">
                <h3>Skills Offered</h3>
                <p class="stat-value" id="skillsOffered">0</p>
            </div>

            <div class="stat-card">
                <h3>Skills Requested</h3>
                <p class="stat-value" id="skillsRequested">0</p>
            </div>

            <div class="stat-card">
                <h3>Messages</h3>
                <p class="stat-value" id="messages">0</p>
            </div>

            <div class="stat-card">
                <h3>P2P Resources</h3>
                <p class="stat-value" id="p2pResources">0</p>
            </div>

            <div class="stat-card">
                <h3>Active Seeders</h3>
                <p class="stat-value" id="activeSeeders">0</p>
            </div>

            <div class="stat-card">
                <h3>Active Leechers</h3>
                <p class="stat-value" id="activeLeechers">0</p>
            </div>

            <div class="stat-card">
                <h3>Connection Requests</h3>
                <p class="stat-value" id="connectionRequests">0</p>
            </div>

        </div>

        <!-- RECENT MESSAGES -->
        <div class="section" id="recentMessagesSection">
            <h3>Recent Messages</h3>
            <div id="recentMessagesContainer">
                <div class="item">Loading...</div>
            </div>
        </div>

    </div>

    <!-- DASHBOARD SCRIPT -->
    <script>

// Reusable HTML escape
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text || '';
    return div.innerHTML;
}

// Load dashboard statistics
const loadDashboardStats = withErrorBoundary(withRetry(async () => {
    const userId = auth.getUserId();
    if (!userId) return;

    loading.showGlobalWithTimeout('Loading dashboard...');

    // Basic Stats
    const stats = await apiCall(`${API_CONFIG.ENDPOINTS.DASHBOARD_STATS}?user_id=${userId}`);

    // P2P Stats
    let p2pStats = { total_resources: 0, active_seeders: 0, active_leechers: 0 };
    try {
        p2pStats = await apiCall('/api/p2p/statistics');
    } catch (err) {
        console.warn("P2P stats not loaded", err);
    }

    // Connection Requests
    let connectionStats = { pending: 0 };
    try {
        const con = await apiCall(`${API_CONFIG.ENDPOINTS.P2P_CONNECTIONS}?user_id=${userId}&type=received`);
        connectionStats.pending = con.filter(c => c.status === "pending").length;
    } catch (err) {
        console.warn("Connection stats not loaded", err);
    }

    // Update UI
    document.getElementById('skillsOffered').textContent = stats.skills_offered || 0;
    document.getElementById('skillsRequested').textContent = stats.skills_requested || 0;
    document.getElementById('messages').textContent = stats.messages || 0;

    document.getElementById('p2pResources').textContent = p2pStats.total_resources || 0;
    document.getElementById('activeSeeders').textContent = p2pStats.active_seeders || 0;
    document.getElementById('activeLeechers').textContent = p2pStats.active_leechers || 0;

    document.getElementById('connectionRequests').textContent = connectionStats.pending || 0;

    await loadRecentMessages();

    loading.hideGlobal();
}, 3, 1000, "Load Dashboard"), "Load Dashboard");


// Load Recent Messages
const loadRecentMessages = withErrorBoundary(async () => {
    const userId = auth.getUserId();
    if (!userId) return;

    const data = await apiCall(`${API_CONFIG.ENDPOINTS.CHATS}?user_id=${userId}&limit=3`);

    const container = document.getElementById("recentMessagesContainer");
    container.innerHTML = "";

    if (!data || data.length === 0) {
        container.innerHTML = `<div class="item">No recent messages</div>`;
        return;
    }

    data.forEach(chat => {
        const name = chat.name || chat.username || `User ${chat.user_id}`;
        const msg = chat.last_msg || "No messages yet";

        const div = document.createElement("div");
        div.className = "item";
        div.innerHTML = `ðŸ’¬ ${escapeHtml(name)}: "${escapeHtml(msg)}"`;
        container.appendChild(div);
    });
}, "Load Recent Messages");


// Init Dashboard
async function initDashboard() {

    if (!auth.requireAuth()) return;

    const username = auth.getUsername();

    // Update Dashboard Title
    const title = document.getElementById("dashboardTitle");
    title.textContent = `Welcome back, ${username}!`;

    // Load Data
    await loadDashboardStats();
}

// Start App
document.addEventListener("DOMContentLoaded", initDashboard);

    </script>

</body>
</html>
