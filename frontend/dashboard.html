<!DOCTYPE html>
<html>
<head>
    <title>Dashboard - SkillSwap</title>
    <link rel="stylesheet" href="css/unified.css">
    <script src="js/api-config.js"></script>
    <script src="js/utils.js"></script>
    <script src="js/auth.js"></script>
</head>
<body>

<!-- Common Navbar will be inserted here by JavaScript -->
<script src="js/common-navbar.js"></script>

<!-- Font Awesome for icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

<!-- MAIN CONTENT -->
<div class="main">

    <h2>Dashboard</h2>

    <!-- STAT CARDS -->
    <div class="stats-grid">
        <div class="stat-card">
            <h3>Skills Offered</h3>
            <p class="stat-value" id="skillsOffered">3</p>
        </div>

        <div class="stat-card">
            <h3>Skills Requested</h3>
            <p class="stat-value" id="skillsRequested">1</p>
        </div>

        <div class="stat-card">
            <h3>Messages</h3>
            <p class="stat-value" id="messages">12</p>
        </div>

        <div class="stat-card">
            <h3>P2P Resources</h3>
            <p class="stat-value" id="p2pResources">0</p>
        </div>

        <div class="stat-card">
            <h3>Active Seeders</h3>
            <p class="stat-value" id="activeSeeders">0</p>
        </div>

        <div class="stat-card">
            <h3>Active Leechers</h3>
            <p class="stat-value" id="activeLeechers">0</p>
        </div>
        
        <div class="stat-card">
            <h3>Connection Requests</h3>
            <p class="stat-value" id="connectionRequests">0</p>
        </div>
    </div>

    <!-- RECENT MESSAGES -->
    <div class="section">
        <h3>Recent Messages</h3>

        <div class="item">ğŸ’¬ John: â€œCan you teach me Python?â€</div>
        <div class="item">ğŸ’¬ Sarah: â€œInterested in your UI/UX skill!â€</div>
        <div class="item">ğŸ’¬ Mike: â€œLetâ€™s schedule our skill swap.â€</div>
    </div>

</div>

<script>
// Logout function (auth.js handles the rest)
function logout() {
    auth.logout();
}

    // Load dashboard statistics with error boundary and retry
const loadDashboardStats = withErrorBoundary(withRetry(async () => {
    const userId = auth.getUserId();
    if (!userId) return;

    loading.showGlobalWithTimeout('Loading dashboard...');
    
    // Load regular dashboard stats
    const stats = await apiCall(`${API_CONFIG.ENDPOINTS.DASHBOARD_STATS}?user_id=${userId}`);
    
    // Load P2P statistics
    let p2pStats = { total_resources: 0, active_seeders: 0, active_leechers: 0 };
    try {
        p2pStats = await apiCall('/api/p2p/statistics');
    } catch (error) {
        console.warn('Failed to load P2P stats:', error);
    }
    
    // Load connection requests
    let connectionStats = { pending: 0 };
    try {
        const connections = await apiCall(`${API_CONFIG.ENDPOINTS.P2P_CONNECTIONS}?user_id=${userId}&type=received`);
        connectionStats.pending = connections.filter(c => c.status === 'pending').length;
    } catch (error) {
        console.warn('Failed to load connection stats:', error);
    }
    
    // Update stat cards with validation
    const skillsOfferedEl = document.getElementById('skillsOffered');
    const skillsRequestedEl = document.getElementById('skillsRequested');
    const messagesEl = document.getElementById('messages');
    const p2pResourcesEl = document.getElementById('p2pResources');
    const activeSeedersEl = document.getElementById('activeSeeders');
    const activeLeechersEl = document.getElementById('activeLeechers');
    const connectionRequestsEl = document.getElementById('connectionRequests');
    
    if (skillsOfferedEl) skillsOfferedEl.textContent = stats.skills_offered || 0;
    if (skillsRequestedEl) skillsRequestedEl.textContent = stats.skills_requested || 0;
    if (messagesEl) messagesEl.textContent = stats.messages || 0;
    if (p2pResourcesEl) p2pResourcesEl.textContent = p2pStats.total_resources || 0;
    if (activeSeedersEl) activeSeedersEl.textContent = p2pStats.active_seeders || 0;
    if (activeLeechersEl) activeLeechersEl.textContent = p2pStats.active_leechers || 0;
    if (connectionRequestsEl) connectionRequestsEl.textContent = connectionStats.pending || 0;
    
    // Load recent messages
    await loadRecentMessages();
    
    loading.hideGlobal();
}, 3, 1000, 'Load Dashboard'), 'Load Dashboard');

// Load recent messages with error boundary
const loadRecentMessages = withErrorBoundary(async () => {
    const userId = auth.getUserId();
    if (!userId) return;
    
    const recentMessages = await apiCall(`${API_CONFIG.ENDPOINTS.CHATS}?user_id=${userId}&limit=3`);
    
    const recentSection = document.querySelector('.section');
    if (!recentSection) return;
    
    const messagesContainer = recentSection.querySelector('.item')?.parentNode;
    if (!messagesContainer) return;
    
    messagesContainer.innerHTML = '';
    
    if (recentMessages && recentMessages.length > 0) {
        recentMessages.slice(0, 3).forEach(chat => {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'item';
            
            const displayName = chat.name || chat.username || `User ${chat.user_id}`;
            const lastMessage = chat.last_msg || 'No messages yet';
            
            messageDiv.innerHTML = `ğŸ’¬ ${escapeHtml(displayName)}: "${escapeHtml(lastMessage)}"`;
            messagesContainer.appendChild(messageDiv);
        });
    } else {
        messagesContainer.innerHTML = '<div class="item">No recent messages</div>';
    }
}, 'Load Recent Messages');

// Utility function to escape HTML (if not already available)
function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Initialize dashboard
async function initDashboard() {
    if (!auth.requireAuth()) return;
    
    const username = auth.getUsername();
    
    // Update profile button with username
    const profileBtn = document.getElementById("profileBtn");
    if (profileBtn) {
        profileBtn.textContent = username;
    }
    
    // Update welcome message or other user-specific content
    const welcomeElements = document.querySelectorAll("h2");
    welcomeElements.forEach(el => {
        if (el.textContent === "Dashboard") {
            el.textContent = `Welcome back, ${username}!`;
        }
    });
    
    // Load dashboard data
    await loadDashboardStats();
}

// Mobile menu toggle is now handled by common-navbar.js

// Run initialization when page loads
document.addEventListener('DOMContentLoaded', initDashboard);
</script>

</body>
</html>
